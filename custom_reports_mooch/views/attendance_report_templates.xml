<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <!-- wrapper requerido -->
  <template id="attendance_pdf">
    <t t-call="web.html_container">
      <t t-call="custom_reports_mooch.attendance_pdf_document"/>
    </t>
  </template>

  <template id="attendance_pdf_document">
    <t t-call="web.external_layout">
      <!-- tarjetas por hoja (default 4) -->
      <t t-set="cpp" t-value="4"/>
      <style>
        .att-card{
            display: inline-block;
            vertical-align: top;
            border: 1px solid #333;
            padding: 8px;
            margin: 6px 6px 0px 0;
            page-break-inside: avoid;
            width: 48%;
            box-sizing: border-box;
        }
        .att-head{
            display: grid;
            grid-template-columns: 80px 1fr 1fr;
            grid-gap: 8px;
            align-items: center;
            margin-bottom: 6px;
        }
        .att-head .pic{
            width: 80px;
            height: 80px;
            border: 1px solid #bbb;
            object-fit: cover;
        }
        .att-title{
            font-weight: 700;
            text-align: center;
            font-size: 14px;
            margin-bottom: 0px;
        }
        .att-kv small{
            color: #555;
        }
        .att-tr .val {
          font-size: 10px;
          font-weight:700; }  /* número pequeño y legible */
        .tbl{
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
        }
        .tbl th, .tbl td{
            border: 1px solid #333;
            padding: 1px;
        }
        .tbl thead th{
            text-align: center;
        }
        .sign{
            border: 1px solid #333;
            height: 24px;
        }
        /* Contenedor para organizar 2 tarjetas por fila */
        .card-row {
            width: 100%;
            display: block;
            margin-bottom: 1px;
        }
        .clearfix {
            clear: both;
        }
        /* === NUEVO: control de anchos y ajuste del Status === */
        .tbl { table-layout: fixed; }  /* respeta anchos del */
        .tbl col.w-date   { width: 16%; }
        .tbl col.w-time   { width: 16%; }   /* Entrada / Comida ini / fin / Salida */
        .tbl col.w-work   { width: 14%; }   /* H. trabajadas / H. comida / Retardo */
        .tbl col.w-status { width: 29%; }  /* más espacio para Status */

        .nowrap      { white-space: nowrap; }              /* HH:MM en una línea */
        .status-cell { white-space: normal; word-break: break-word; } /* Status completo */

        /* ====== AÑADIDO: estilos de status ====== */
        .status-pill {
            padding: 2px 2px;
            border-radius: 6px;
            color: #fff;
            font-weight: 700;
            font-size: 10px;
            display: inline-block;
        }
        .st-green  { background: #2e7d32; }  /* Asistencia */
        .st-orange { background: #ef6c00; }  /* Retardo */
        .st-red    { background: #c62828; }  /* Falta */
        .st-blue   { background: #1565c0; }  /* Descanso */
        .st-purple { background: #6a1b9a; }  /* Vacaciones */
        .st-teal   { background: #00695c; }  /* Permiso c/goce */
        .st-gray   { background: #455a64; }  /* Permiso s/goce */
      </style>

      <div class="page">
        <div class="att-title"><t t-esc="title"/></div>

        <!-- CORRECCIÓN: Cambiar idx por c_index -->
        <t t-foreach="cards" t-as="c" t-foreach-index="c_index">
          <div class="att-card" t-att-style="'width:%s;' % card_width">
            <div class="att-head">
              <!-- <img class="pic" t-att-src="'/web/image/hr.employee/%s/image_128' % c['emp'].id"/> -->
              <div class="att-kv">
                <div><small>No.Empleado:</small> <t t-esc="c['emp'].barcode or 'no asignado'"/></div>
                <div><t t-esc="c['emp'].name"/></div>
                <div><small>Departamento:</small> <t t-esc="c['dept']"/></div>
                <div><small>Sucursal:</small> <t t-esc="c['suc'] or '—'"/></div>
              </div>
            </div>

            <table class="tbl">
              <!-- NUEVO: distribución de anchos por columna -->
              <colgroup>
                <col class="w-date"/>
                <col class="w-time"/><col class="w-time"/><col class="w-time"/><col class="w-time"/>
                <col class="w-work"/><col class="w-work"/><col class="w-work"/>
                <col class="w-status"/>
              </colgroup>

              <thead>
                <tr>
                  <th rowspan="2">Fecha</th>
                  <th colspan="4">Checadas</th>
                  <th rowspan="2">Horas trabajadas</th>
                  <th rowspan="2">Horas de comida</th>
                  <th rowspan="2">Retardo</th>
                  <th rowspan="2">Status</th>
                </tr>
                <tr>
                  <th>Entrada</th>
                  <th>Inicia Comida</th>
                  <th>Termina Comida</th>
                  <th>Salida</th>
                </tr>
              </thead>

              <tbody>
                <t t-foreach="c['rows']" t-as="r">
                  <tr>
                    <td><t t-esc="r['fecha_lbl']"/></td>

                    <!-- HH:MM en una sola línea y centrado -->
                    <td class="nowrap" style="text-align:center;"><t t-esc="r['entrada']"/></td>
                    <td class="nowrap" style="text-align:center;"><t t-esc="r['comida_ini']"/></td>
                    <td class="nowrap" style="text-align:center;"><t t-esc="r['comida_fin']"/></td>
                    <td class="nowrap" style="text-align:center;"><t t-esc="r['salida']"/></td>

                    <td class="nowrap" style="text-align:center;"><t t-esc="r['h_trab']"/></td>
                    <td class="nowrap" style="text-align:center;"><t t-esc="r['h_comida']"/></td>
                    <td class="nowrap" style="text-align:center;"><t t-esc="r['retardo']"/></td>

                    <!-- Deja que el Status tenga más ancho y se parta si es largo -->
                    <td class="status-cell" style="text-align:center;">
                      <span t-att-class="'status-pill ' + (
                          'st-green'  if r['status']=='Asistencia'      else
                          ('st-orange' if r['status']=='Retardo'        else
                          ('st-red'    if r['status']=='Falta'          else
                          ('st-blue'   if r['status']=='Descanso'       else
                          ('st-purple' if r['status']=='Vacaciones'     else
                          ('st-teal'   if r['status']=='Permiso c/goce' else
                          'st-gray'))))) )">
                        <t t-esc="r['status']"/>
                      </span>
                    </td>
                  </tr>
                </t>
              </tbody>
            </table>
            <div class="att-tr" style="text-align:right;">
              <div>
                <small>Tiempo Total Retardo:</small>
                <span class="val"><t t-esc="c['retardo_total']"/></span>
              </div>
            </div>
            <t t-if="include_signature">
              <div style="margin-top:1px;">
                <div class="sign"></div>
                <div style="text-align:center; font-weight:1000; margin-top:1px;">Nombre y Firma del empleado</div>
              </div>
            </t>
          </div>

          <!-- CORRECCIÓN: Cambiar idx por c_index -->
          <t t-if="cpp and (((c_index + 1) % cpp) == 0)">
            <div style="page-break-after:always;"></div>
          </t>
        </t>
      </div>
    </t>
  </template>
</odoo>
