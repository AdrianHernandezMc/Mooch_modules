<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <template id="attendance_admin_pdf_document">
    <t t-call="web.external_layout">
      <t t-set="doc_ids" t-value="doc_ids"/>
      <t t-set="docs" t-value="docs"/>
      <t t-set="doc_model" t-value="doc_model"/>
      
      <!-- PREPARAR DATASET CORRECTAMENTE -->
      <t t-set="root_data" t-value="data or {}"/>
      <t t-set="report_data" t-value="root_data.get('form', {}) or {}"/>
      <t t-set="title" t-value="report_data.get('title', 'Reporte Administrativos (Asistencias)')"/>

      <!-- Arrays para meses en español -->
      <t t-set="spanish_months" t-value="['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']"/>
      
      <!-- Obtener primer y último día del reporte -->
      <t t-set="day_list" t-value="report_data.get('day_list', [])"/>
      <t t-set="first_day" t-value="day_list[0] if day_list else ''"/>
      <t t-set="last_day" t-value="day_list[-1] if day_list else ''"/>
      
      <!-- Formatear fechas en español -->
      <t t-set="first_date_formatted">
        <t t-if="first_day">
          <t t-set="first_parts" t-value="first_day.split('-')"/>
          <t t-set="first_day_num" t-value="first_parts[2]"/>
          <t t-set="first_month_num" t-value="first_parts[1]"/>
          <t t-set="first_year" t-value="first_parts[0]"/>
          <t t-set="first_month_name" t-value="spanish_months[int(first_month_num)-1]"/>
          <t t-esc="first_day_num"/> de <t t-esc="first_month_name"/> de <t t-esc="first_year"/>
        </t>
      </t>
      
      <t t-set="last_date_formatted">
        <t t-if="last_day">
          <t t-set="last_parts" t-value="last_day.split('-')"/>
          <t t-set="last_day_num" t-value="last_parts[2]"/>
          <t t-set="last_month_num" t-value="last_parts[1]"/>
          <t t-set="last_year" t-value="last_parts[0]"/>
          <t t-set="last_month_name" t-value="spanish_months[int(last_month_num)-1]"/>
          <t t-esc="last_day_num"/> de <t t-esc="last_month_name"/> de <t t-esc="last_year"/>
        </t>
      </t>

      <!-- tarjetas por hoja (default 4) -->
      <t t-set="cpp" t-value="4"/>
      <style>
        .att-card{
            display: inline-block;
            vertical-align: top;
            border: 1px solid #333;
            padding: 8px;
            margin: 6px 6px 0px 0;
            page-break-inside: avoid;
            width: 48%;
            box-sizing: border-box;
        }
        .att-head{
            display: grid;
            grid-template-columns: 80px 1fr 1fr;
            grid-gap: 8px;
            align-items: center;
            margin-bottom: 6px;
        }
        .att-head .pic{
            width: 80px;
            height: 80px;
            border: 1px solid #bbb;
            object-fit: cover;
        }
        .att-title{
            font-weight: 700;
            text-align: center;
            font-size: 14px;
            margin-bottom: 0px;
        }
        .att-kv small{
            color: #555;
        }
        .att-tr .val {
          font-size: 10px;
          font-weight:700; }  /* número pequeño y legible */
        .tbl{
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
        }
        .tbl th, .tbl td{
            border: 1px solid #333;
            padding: 1px;
        }
        .tbl thead th{
            text-align: center;
        }
        .sign{
            border: 1px solid #333;
            height: 24px;
        }
        /* === NUEVO: control de anchos y ajuste del Status === */
        .tbl { table-layout: fixed; }  /* respeta anchos del */
        .tbl col.w-date   { width: 16%; }
        .tbl col.w-time   { width: 16%; }   /* Entrada / Comida ini / fin / Salida */
        .tbl col.w-work   { width: 14%; }   /* H. trabajadas / H. comida / Retardo */
        .tbl col.w-status { width: 29%; }  /* más espacio para Status */

        .nowrap      { white-space: nowrap; }              /* HH:MM en una línea */
        .status-cell { white-space: normal; word-break: break-word; } /* Status completo */

        /* ====== AÑADIDO: estilos de status ====== */
        .status-pill {
            padding: 2px 2px;
            border-radius: 6px;
            color: #fff;
            font-weight: 700;
            font-size: 10px;
            display: inline-block;
        }
        .st-green  { background: #2e7d32; }  /* Asistencia */
        .st-orange { background: #ef6c00; }  /* Retardo */
        .st-red    { background: #c62828; }  /* Falta */
        .st-blue   { background: #1565c0; }  /* Descanso */
        .st-purple { background: #6a1b9a; }  /* Vacaciones */
        .st-teal   { background: #00695c; }  /* Permiso c/goce */
        .st-gray   { background: #455a64; }  /* Permiso s/goce */

        .header-date {
            text-align: center;
            margin-bottom: 15px;
            padding: 6px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            font-size: 12px;
            font-weight: bold;
        }
      </style>

      <!-- AGREGAR ETIQUETA MAIN REQUERIDA -->
      <main>
        <div class="page">
          <div class="att-title"><t t-esc="title"/></div>

          <!-- ENCABEZADO CON RANGO DE FECHAS EN ESPAÑOL -->
          <div class="header-date">
            Registro de asistencia del <t t-esc="first_date_formatted"/> al <t t-esc="last_date_formatted"/>
          </div>

          <!-- CORRECCIÓN: Usar emp_index en lugar de c_index -->
          <t t-foreach="report_data.get('employees', [])" t-as="emp" t-emp-index="emp_index">
            <div class="att-card" t-att-style="'width:%s;' % '48%'">
              <div class="att-head">
                <div class="att-kv">
                  <div><small>No.Empleado:</small> <t t-esc="emp['barcode'] or 'no asignado'"/></div>
                  <div><t t-esc="emp['name']"/></div>
                  <div><small>Departamento:</small> <t t-esc="emp['department_name']"/></div>
                  <div><small>Sucursal:</small> <t t-esc="emp['work_location_name'] or '—'"/></div>
                </div>
              </div>

              <table class="tbl">
                <colgroup>
                  <col class="w-date"/>
                  <col class="w-time"/><col class="w-time"/><col class="w-time"/><col class="w-time"/>
                  <col class="w-work"/><col class="w-work"/><col class="w-work"/>
                  <col class="w-status"/>
                </colgroup>

                <thead>
                  <tr>
                    <th rowspan="2">Fecha</th>
                    <th colspan="4">Checadas</th>
                    <th rowspan="2">Horas trabajadas</th>
                    <th rowspan="2">Horas de comida</th>
                    <th rowspan="2">Retardo</th>
                    <th rowspan="2">Status</th>
                  </tr>
                  <tr>
                    <th>Entrada</th>
                    <th>Inicia Comida</th>
                    <th>Termina Comida</th>
                    <th>Salida</th>
                  </tr>
                </thead>

                <tbody>
                  <t t-foreach="report_data.get('day_list', [])" t-as="d_str">
                    <!-- ACCESO CORRECTO A LOS DATOS -->
                    <t t-set="emp_data" t-value="report_data.get('per_emp_day_summary', {}).get(str(emp['id']), {})"/>
                    <t t-set="day_data" t-value="emp_data.get(d_str, {})"/>
                    <t t-set="status" t-value="day_data.get('status', 'Falta')"/>
                    
                    <tr>
                      <td><t t-esc="d_str"/></td>

                      <!-- Checadas -->
                      <td class="nowrap" style="text-align:center;"><t t-esc="day_data.get('first_in_s', '—')"/></td>
                      <td class="nowrap" style="text-align:center;"><t t-esc="day_data.get('lunch_out_s', '—')"/></td>
                      <td class="nowrap" style="text-align:center;"><t t-esc="day_data.get('lunch_in_s', '—')"/></td>
                      <td class="nowrap" style="text-align:center;"><t t-esc="day_data.get('last_out_s', '—')"/></td>

                      <!-- Totales -->
                      <td class="nowrap" style="text-align:center;"><t t-esc="day_data.get('work_str', '00:00')"/></td>
                      <td class="nowrap" style="text-align:center;"><t t-esc="day_data.get('lunch_str', '00:00')"/></td>
                      <td class="nowrap" style="text-align:center;"><t t-esc="day_data.get('retardo', '00:00')"/></td>

                      <td class="status-cell" style="text-align:center;">
                        <span t-att-class="'status-pill ' + (
                            'st-green'  if status=='Asistencia'      else
                            ('st-orange' if status=='Retardo'        else
                            ('st-red'    if status=='Falta'          else
                            ('st-blue'   if status=='Descanso'       else
                            ('st-purple' if status=='Vacaciones'     else
                            ('st-teal'   if status=='Permiso c/goce' else
                            'st-gray'))))) )">
                          <t t-esc="status"/>
                        </span>
                      </td>
                    </tr>
                  </t>
                </tbody>
              </table>
              
              <t t-if="report_data.get('include_signature')">
                <div style="margin-top:1px;">
                  <div class="sign"></div>
                  <div style="text-align:center; font-weight:1000; margin-top:1px;">Nombre y Firma del empleado</div>
                </div>
              </t>
            </div>

            <!-- CORRECCIÓN: Usar emp_index en lugar de c_index -->
            <t t-if="cpp and (((emp_index + 1) % cpp) == 0) and ((emp_index + 1) != len(report_data.get('employees', [])))">
              <div style="page-break-after:always;"></div>
            </t>
          </t>
        </div>
      </main>
    </t>
  </template>
</odoo>