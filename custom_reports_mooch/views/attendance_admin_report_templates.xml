<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <template id="attendance_admin_pdf_document">
    <t t-call="web.external_layout">
      <t t-set="doc_ids" t-value="doc_ids"/>
      <t t-set="docs" t-value="docs"/>
      <t t-set="doc_model" t-value="doc_model"/>
      
      <!-- Preparar dataset correctamente -->
      <t t-set="root_data" t-value="data or {}"/>
      <t t-set="report_data" t-value="root_data.get('form', {}) or {}"/>

      <t t-set="title" t-value="report_data.get('title', 'Reporte Administrativos (Asistencias)')"/>
      
      <style>
        /* Tus estilos actuales... */
        .att-card{
            display: inline-block;
            vertical-align: top;
            border: 1px solid #333;
            padding: 8px;
            margin: 6px 6px 12px 0;
            page-break-inside: avoid;
            width: 49%;
            box-sizing: border-box;
        }
        .att-head{
            margin-bottom: 6px;
        }
        .att-title{
            font-weight: 700;
            text-align: center;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .att-kv small{
            color: #555;
            font-size: 10px;
        }
        .tbl{
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            table-layout: fixed;
        }
        .tbl th, .tbl td{
            border: 1px solid #333;
            padding: 2px;
            text-align: center;
        }
        .tbl thead th{
            text-align: center;
            background-color: #f5f5f5;
            font-weight: bold;
        }
        .sign{
            border: 1px solid #333;
            height: 24px;
            margin-top: 8px;
        }
        
        .tbl col.w-date   { width: 12%; }
        .tbl col.w-time   { width: 8%; }
        .tbl col.w-work   { width: 8%; }
        .tbl col.w-status { width: 16%; }

        .nowrap      { white-space: nowrap; }
        .status-cell { white-space: normal; word-break: break-word; }

        .status-pill {
            padding: 2px 4px;
            border-radius: 6px;
            color: #fff;
            font-weight: 700;
            font-size: 9px;
            display: inline-block;
        }
        .st-green  { background: #2e7d32; }
        .st-orange { background: #ef6c00; }
        .st-red    { background: #c62828; }
        .st-blue   { background: #1565c0; }
        .st-purple { background: #6a1b9a; }
        .st-teal   { background: #00695c; }
        .st-gray   { background: #455a64; }
        
        .employee-name { 
            font-weight: bold; 
            font-size: 12px; 
            margin-bottom: 3px; 
        }
      </style>

      <main>
        <div class="page">
          <div class="att-title"><t t-out="title"/></div>
          
          <div style="text-align:center; margin-bottom:15px; padding:6px; background:#f9f9f9; border:1px solid #ddd; font-size:10px;">
            <strong>Rango:</strong> <t t-out="report_data.get('dfrom', '—')"/> → <t t-out="report_data.get('dto', '—')"/> | 
            <strong>Zona Horaria:</strong> <t t-out="report_data.get('tz', '—')"/>
          </div>

          <!-- DEBUG: Mostrar estructura de datos -->
          <t t-if="debug">
            <div style="background:yellow; padding:10px; margin-bottom:10px;">
              <strong>DEBUG:</strong>
              <div>Empleados: <t t-out="len(report_data.get('employees', []))"/></div>
              <div>Días: <t t-out="len(report_data.get('day_list', []))"/></div>
              <div>Per_emp_day_summary keys: <t t-out="report_data.get('per_emp_day_summary', {}).keys()"/></div>
            </div>
          </t>

          <t t-foreach="report_data.get('employees', [])" t-as="emp" t-emp-index="emp_index">
            <div class="att-card">
              <div class="att-head">
                <div class="att-kv">
                  <div class="employee-name"><t t-out="emp['name']"/></div>
                  <div><small>No. Empleado:</small> <t t-out="emp['barcode']"/></div>
                  <div><small>Departamento:</small> <t t-out="emp['department_name']"/></div>
                  <div><small>Sucursal:</small> <t t-out="emp['work_location_name']"/></div>
                </div>
              </div>

              <table class="tbl">
                <colgroup>
                  <col class="w-date"/>
                  <col class="w-time"/>
                  <col class="w-time"/>
                  <col class="w-time"/>
                  <col class="w-time"/>
                  <col class="w-work"/>
                  <col class="w-work"/>
                  <col class="w-work"/>
                  <col class="w-status"/>
                </colgroup>

                <thead>
                  <tr>
                    <th rowspan="2">Fecha</th>
                    <th colspan="4">Checadas</th>
                    <th rowspan="2">Horas<br/>trabajadas</th>
                    <th rowspan="2">Horas<br/>de comida</th>
                    <th rowspan="2">Retardo</th>
                    <th rowspan="2">Status</th>
                  </tr>
                  <tr>
                    <th>Entrada</th>
                    <th>Inicia<br/>Comida</th>
                    <th>Termina<br/>Comida</th>
                    <th>Salida</th>
                  </tr>
                </thead>

                <tbody>
                  <t t-foreach="report_data.get('day_list', [])" t-as="d_str">
                    <!-- CORRECCIÓN PRINCIPAL: Obtener datos correctamente -->
                    <t t-set="emp_data" t-value="report_data.get('per_emp_day_summary', {}).get(str(emp['id']), {})"/>
                    <t t-set="day_data" t-value="emp_data.get(d_str, {})"/>
                    <t t-set="status" t-value="day_data.get('status', 'Falta')"/>
                    
                    <tr>
                      <!-- Fecha -->
                      <td class="nowrap"><t t-out="d_str"/></td>
                      
                      <!-- Checadas -->
                      <td class="nowrap"><t t-out="day_data.get('first_in_s', '—')"/></td>
                      <td class="nowrap"><t t-out="day_data.get('lunch_out_s', '—')"/></td>
                      <td class="nowrap"><t t-out="day_data.get('lunch_in_s', '—')"/></td>
                      <td class="nowrap"><t t-out="day_data.get('last_out_s', '—')"/></td>
                      
                      <!-- Totales -->
                      <td class="nowrap"><t t-out="day_data.get('work_str', '00:00')"/></td>
                      <td class="nowrap"><t t-out="day_data.get('lunch_str', '00:00')"/></td>
                      <td class="nowrap"><t t-out="day_data.get('retardo', '00:00')"/></td>
                      
                      <!-- Status -->
                      <td class="status-cell">
                        <span t-att-class="'status-pill ' + (
                            'st-green'  if status=='Asistencia'      else
                            ('st-orange' if status=='Retardo'        else
                            ('st-red'    if status=='Falta'          else
                            ('st-blue'   if status=='Descanso'       else
                            ('st-purple' if status=='Vacaciones'     else
                            ('st-teal'   if status=='Permiso c/goce' else
                            'st-gray'))))) )">
                          <t t-out="status"/>
                        </span>
                      </td>
                    </tr>
                  </t>
                </tbody>
              </table>

              <t t-if="report_data.get('include_signature')">
                <div style="margin-top:10px;">
                  <div class="sign"></div>
                  <div style="text-align:center; font-weight:bold; margin-top:3px; font-size:9px;">
                    Nombre y Firma del empleado
                  </div>
                </div>
              </t>
            </div>

            <!-- Salto de página cada 2 empleados -->
            <t t-if="(emp_index + 1) % 2 == 0 and (emp_index + 1) != len(report_data.get('employees', []))">
              <div style="page-break-after:always;"></div>
            </t>
          </t>
        </div>
      </main>
    </t>
  </template>
</odoo>