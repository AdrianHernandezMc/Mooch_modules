<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="point_of_sale.ApartadosPopup">
        <div class="popup apartados-popup">
            <!-- Header -->
            <div class="header bg-primary text-white p-3">
                <h2 class="m-0">Gestión de Apartados</h2>
                <button class="btn btn-light btn-sm" t-on-click="closePopup">
                    <i class="fa fa-times me-1"></i>
                    Cerrar
                </button>
            </div>

            <!-- Contenido -->
            <div class="content p-3" style="height: 80vh; overflow-y: auto;">
                
                <!-- Botones de acción -->
                <div class="row mb-3">
                    <div class="col">
                        <button class="btn btn-success w-100" t-on-click="crearApartado" t-att-disabled="state.cargando">
                            <i class="fa fa-save me-2"></i>
                            Guardar Orden como Apartado
                        </button>
                    </div>
                </div>

                <div class="Product_sale">
                    <h3><t t-esc="props.title" /></h3>
                    <div style="height: 20px;"></div>
                    <div class="lines">
                        <t t-if="props.lines &amp;&amp; props.lines.length">
                            <t t-foreach="props.lines" t-as="line" t-key="line.product_id">
                                <div class="line apartados-line d-flex justify-content-between align-items-center">
                                    <span><t t-esc="line.name" /></span>
                                    <span><t t-esc="line.qty" /> x $<t t-esc="line.price_unit" /></span>
                                </div>
                            </t>
                        </t>
                        <t t-else="">
                            <p class="text-muted">No hay productos seleccionados.</p>
                        </t>
                    </div>
                </div>

                <!-- <div class="footer">
                    <button class="btn btn-primary" t-on-click="confirm">Guardar</button>
                    <button class="btn btn-secondary" t-on-click="cancel">Cancelar</button>
                </div> -->

                <div class="div2 mt-3"> </div>
                <div style="height: 20px;"></div>

                <div class="row">
                    <!-- Lista de Apartados -->
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="m-0">Lista de Apartados</h5>
                            </div>
                            <div class="card-body p-0">
                                <div t-if="state.cargando" class="text-center p-3">
                                    <i class="fa fa-spinner fa-spin me-2"></i>
                                    Cargando...
                                </div>
                                <div t-else="" class="list-group list-group-flush">
                                    <t t-foreach="state.apartados" t-as="apartado" t-key="apartado.id">
                                        <button type="button" 
                                                class="list-group-item list-group-item-action"
                                                t-att-class="{'active': state.apartadoSeleccionado &amp;&amp; state.apartadoSeleccionado.id === apartado.id}"
                                                t-on-click="() => seleccionarApartado(apartado)">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1" t-esc="apartado.name"/>
                                                <small t-esc="apartado.state"/>
                                            </div>
                                            <p class="mb-1" t-esc="apartado.note || 'Sin nota'"/>
                                            <small>
                                                Total: <t t-esc="'$' + apartado.amount_total"/>
                                                | Cajero: <t t-esc="apartado.cashier"/>
                                            </small>
                                        </button>
                                    </t>
                                    <div t-if="state.apartados.length === 0" class="text-center p-3 text-muted">
                                        <i class="fa fa-inbox fa-2x mb-2"></i>
                                        <p>No hay apartados</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Detalles del Apartado Seleccionado -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="m-0">Detalles</h5>
                                <button t-if="state.apartadoSeleccionado" 
                                        class="btn btn-danger btn-sm" 
                                        t-on-click="eliminarApartado">
                                    <i class="fa fa-trash me-1"></i>
                                    Eliminar
                                </button>
                            </div>
                            <div class="card-body">
                                <t t-if="state.apartadoSeleccionado">
                                    <h6 t-esc="state.apartadoSeleccionado.name"/>
                                    <p><strong>Estado:</strong> <span t-esc="state.apartadoSeleccionado.state"/></p>
                                    <p><strong>Total:</strong> <span t-esc="'$' + state.apartadoSeleccionado.amount_total"/></p>
                                    <p><strong>Pagado:</strong> <span t-esc="'$' + state.apartadoSeleccionado.amount_paid"/></p>
                                    <p><strong>Cajero:</strong> <span t-esc="state.apartadoSeleccionado.cashier"/></p>
                                    
                                    <h6 class="mt-3">Productos:</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Producto</th>
                                                    <th>Cant</th>
                                                    <th>Precio</th>
                                                    <th>Subtotal</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="state.apartadoSeleccionado.lineas" t-as="linea" t-key="linea.id">
                                                    <tr>
                                                        <td t-esc="linea.name"/>
                                                        <td t-esc="linea.qty"/>
                                                        <td t-esc="'$' + linea.price_unit"/>
                                                        <td t-esc="'$' + linea.price_subtotal_incl"/>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <button class="btn btn-primary w-100 mt-3" t-on-click="cargarAlPOS">
                                        <i class="fa fa-cart-plus me-2"></i>
                                        Cargar al POS
                                    </button>
                                </t>
                                <t t-else="">
                                    <p class="text-muted text-center">Selecciona un apartado para ver los detalles</p>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>
</templates>