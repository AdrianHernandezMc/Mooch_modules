<?xml version="1.0" encoding="UTF-8"?>
<templates id="pos_receipt_items_ext" xml:space="preserve">
  <t t-inherit="point_of_sale.OrderReceipt" t-inherit-mode="extension" owl="1">


    <!-- ========================================================= -->
    <!-- 1. HERENCIA PRINCIPAL: CUERPO DEL TICKET (OrderReceipt)   -->
    <!-- ========================================================= -->

    <!-- 1. ARTÍCULOS VENDIDOS -->
    <xpath expr="//div[contains(@class,'paymentlines')][@t-foreach='props.data.paymentlines']" position="after">
      <div class="paymentlines items-count">
        <span>Artículos vendidos</span>
        <span t-esc="props.data.qty_articles" class="pos-receipt-right-align"/>
      </div>
    </xpath>

    <!-- 2. MOVER 'CHANGE' (CAMBIO) -->
    <xpath expr="//div[contains(@class,'receipt-change')]" position="replace">
      <t/>
    </xpath>

    <xpath expr="//div[contains(@class,'pos-receipt-amount')][span[@t-esc='props.formatCurrency(props.data.amount_total)']]" position="after">
      <div class="pos-receipt-amount receipt-change mt-2">
        CHANGE
        <span t-esc="props.formatCurrency(props.data.change)" class="pos-receipt-right-align"/>
      </div>
    </xpath>

    <!-- 3. ELIMINAR 'POWERED BY ODOO' -->
    <xpath expr="//div[contains(@class,'pos-receipt-order-data')]//p[contains(text(),'Powered by Odoo')]" position="replace">
      <t/>
    </xpath>

    <!-- 4. BLOQUE UNIFICADO: TIPO DE VENTA + VALES DE REGALO -->
    <xpath expr="//div[contains(@class,'pos-receipt-taxes')]" position="after">

      <!-- A) TIPO DE VENTA -->
      <t t-if="props.data.sale_type">
        <div class="pos-sale-type">
          <span t-esc="props.data.sale_type" style="display:block; text-align:center; font-weight:bold; font-size:18px;"/>
        </div>
      </t>

      <!-- B) VALES / CUPONES (Lógica corregida) -->
      <t t-if="props.data.new_coupon_info and props.data.new_coupon_info.length > 0">
        <div class="pos-coupon-section" style="margin-top: 15px; border-top: 1px dashed #000; padding-top: 10px;">
            <div style="text-align: center; font-weight: bold; margin-bottom: 10px;">Codigos de cupnes:</div>

            <t t-foreach="props.data.new_coupon_info" t-as="coupon_info" t-key="coupon_info.code">
                <!-- Contenedor individual de cada vale -->
                <div style="background: white; padding-bottom: 15px; margin-bottom: 10px;">

                    <!-- Nombre del vale -->
                    <div style="text-align: center; font-size: 110%; font-weight: bold;">
                        <t t-esc="coupon_info.program_name"/>
                    </div>

                    <!-- Fecha -->
                    <div style="text-align: center; font-size: 90%; margin-bottom: 5px;">
                        <span>Vence: </span>
                        <t t-if="coupon_info.expiration_date">
                            <t t-esc="coupon_info.expiration_date"/>
                        </t>
                        <t t-else="">Indefinido</t>
                    </div>

                    <!-- IMAGEN DEL CÓDIGO DE BARRAS -->
                    <div style="display: flex; justify-content: center;">
                        <img t-att-src="'/report/barcode/Code128/' + coupon_info.code + '?width=800&amp;height=150&amp;humanreadable=0'"
                             alt="Barcode"
                             style="width: 200px; height: 60px; max-width: 95%;"/>
                    </div>

                    <!-- NÚMERO DEL CÓDIGO (estilo grande) -->
                    <div style="text-align: center; margin-top: 2px;
                                font-family: monospace; font-size: 14pt; font-weight: bold; letter-spacing: 2px;">
                        <t t-esc="coupon_info.code"/>
                    </div>

                </div>
            </t>
        </div>
      </t>
    </xpath>

    <!-- 5. CÓDIGO DE BARRAS DE LA ORDEN (ORIGINAL) -->
    <xpath expr="//div[contains(@class,'pos-receipt-order-data')][div[@id='order-date']]" position="before">
        <t t-if="props.data.order_barcode">
            <div class="barcode-container"
                style="text-align: center; margin-top: 20px; margin-bottom: 10px; padding: 8px 5px; background: white;">
                <div style="display: flex; justify-content: center;">
                    <img t-att-src="'/report/barcode/Code128/' + props.data.order_barcode + '?width=800&amp;height=150&amp;humanreadable=0'"
                        t-att-alt="props.data.order_barcode"
                        class="thermal-barcode"
                        style="width: 95%; max-width: 200px; height: 80px;"/>
                </div>
            </div>
            <div class="barcode-number"
                style="text-align: center; margin-top: 5px; margin-bottom: 20px;
                        font-family: monospace; font-size: 14pt; font-weight: bold; letter-spacing: 2px;">
                <t t-esc="props.data.order_barcode"/>
            </div>
        </t>
    </xpath>

    <!-- 6. OCULTAR EL CUPÓN ORIGINAL DE ODOO -->
    <xpath expr="//div[hasclass('pos-receipt')]" position="inside">
        <style>
            .pos-coupon-rewards { display: none !important; }
        </style>
    </xpath>

    <!-- 7. AGRANDAR LA LÍNEA DE MÉTODO DE PAGO (NUEVO) -->
    <xpath expr="//div[contains(@class,'paymentlines')][@t-foreach='props.data.paymentlines']" position="attributes">
        <!-- Puedes ajustar 20px al tamaño que desees (ej: 1.5em, 18px, etc.) -->
        <attribute name="style">font-size: 20px; font-weight: bold; margin-bottom: 5px;</attribute>
    </xpath>
  </t>

  <!-- ========================================================= -->
  <!-- 2. HERENCIA SECUNDARIA: CABECERA (ReceiptHeader)          -->
  <!--    AQUÍ CAMBIAMOS EL NOMBRE DEL CAJERO                    -->
  <!-- ========================================================= -->
  <t t-inherit="point_of_sale.ReceiptHeader" t-inherit-mode="extension" owl="1">
    
    <xpath expr="//div[contains(@class, 'cashier')]" position="replace">
        <div t-if="props.data.cashier" class="cashier">
            <div>--------------------------------</div>
            
            <!-- LÓGICA PARA ACORTAR NOMBRE: Primer Nombre + Último Apellido -->
            <t t-set="full_name" t-value="props.data.cashier"/>
            <t t-set="name_parts" t-value="full_name.split(' ')"/>
            
            <!-- Tomamos el primer nombre -->
            <t t-set="short_name" t-value="name_parts[0]"/>
            
            <!-- Si tiene más de una palabra, agregamos la última -->
            <t t-if="name_parts.length > 1">
                <t t-set="short_name" t-value="short_name + ' ' + name_parts[name_parts.length - 1]"/>
            </t>

            <!-- MOSTRAR EN PANTALLA -->
            <div style="font-weight: bold; font-size: 16px;">
                Le atendió: <t t-esc="short_name" />
            </div>
        </div>
    </xpath>

  </t>
</templates>