<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">

    <t t-name="point_of_sale.SaleDetailsReport" t-inherit="point_of_sale.SaleDetailsReport" t-inherit-mode="extension">

        <xpath expr="//div[@class='pos-receipt']" position="replace">
            <div class="pos-receipt" style="font-family: 'Courier New', monospace; font-size: 16px; line-height: 1.1; font-weight: bold; color: #000; width: 140mm; max-width: 100%; margin: 0 auto;">

                <!-- 1. ENCABEZADO -->
                <div style="text-align: center;">
                    <t t-if="pos.company_logo_base64">
                        <img t-att-src="pos.company_logo_base64" style="max-width: 50%; max-height: 70px; filter: grayscale(100%) contrast(150%); margin-bottom: 5px;"/>
                        <br/>
                    </t>
                    <div style="font-size: 26px; font-weight: 900; margin-top:2px;">
                        <t t-esc="pos.company.name" />
                    </div>
                    <div style="font-size: 24px; border: 3px solid black; padding: 3px; margin: 5px 0;">
                        <t t-if="is_z_report">CORTE FINAL (Z)</t>
                        <t t-else="">CORTE DE CAJA (X)</t>
                    </div>
                    <div style="font-size: 20px; text-align: left; margin-bottom: 5px;">
                        <div>üìÖ <t t-esc="date" /></div>
                        <div>üë§ <t t-esc="user_name || 'Cajero'" /></div>
                        <div>üè™ <t t-esc="pos.config.name" /></div>
                        <div>üî¢ Sesi√≥n: <t t-esc="session_name" /></div>

                        <div style="border-top: 1px dashed black; margin-top: 3px; padding-top: 2px;">
                            <div>üßæ Transacciones: <t t-esc="orders_count || 0" /></div>
                            <t t-if="is_z_report">
                                <div style="font-size: 18px;">Desde: <t t-esc="folio_start" /></div>
                                <div style="font-size: 18px;">Hasta: <t t-esc="folio_end" /></div>
                            </t>
                        </div>
                    </div>
                </div>

                <!-- 2. DETALLE DE VENTAS -->
                <div style="border-bottom: 2px solid black; margin-bottom: 3px;"></div>
                <div style="font-size: 24px; text-align: center;">VENTA</div>
                <div style="border-bottom: 2px solid black; margin-bottom: 5px;"></div>

                <!-- Lista de m√©todos de pago -->
                <!-- 1. PRIMERO EFECTIVO -->
                <t t-foreach="payments" t-as="payment" t-key="payment_index">
                    <t t-set="p_name" t-value="payment['name'].toLowerCase()"/>
                    <t t-if="p_name.includes('efectivo') or p_name.includes('cash')">
                        <div style="display: flex; justify-content: space-between; font-size: 20px">
                            <span t-esc="payment['name'].substr(0,15)" />
                            <span t-esc="formatCurrency(payment['total'] || 0, false)" />
                        </div>
                    </t>
                </t>

                <!-- 2. SEGUNDO D√âBITO -->
                <t t-foreach="payments" t-as="payment" t-key="payment_index">
                    <t t-set="p_name" t-value="payment['name'].toLowerCase()"/>
                    <t t-if="p_name.includes('d√©bito') or p_name.includes('debito')">
                        <div style="display: flex; justify-content: space-between; font-size: 20px">
                            <span t-esc="payment['name'].substr(0,15)" />
                            <span t-esc="formatCurrency(payment['total'] || 0, false)" />
                        </div>
                    </t>
                </t>

                <!-- 3. TERCERO CR√âDITO -->
                <t t-foreach="payments" t-as="payment" t-key="payment_index">
                    <t t-set="p_name" t-value="payment['name'].toLowerCase()"/>
                    <t t-if="p_name.includes('cr√©dito') or p_name.includes('credito')">
                        <div style="display: flex; justify-content: space-between; font-size: 20px">
                            <span t-esc="payment['name'].substr(0,15)" />
                            <span t-esc="formatCurrency(payment['total'] || 0, false)" />
                        </div>
                    </t>
                </t>

                <!-- 4. EL RESTO (Lo que no sea ni efectivo, ni debito, ni credito) -->
                <t t-foreach="payments" t-as="payment" t-key="payment_index">
                    <t t-set="p_name" t-value="payment['name'].toLowerCase()"/>
                    <t t-if="!p_name.includes('efectivo') and !p_name.includes('cash') and !p_name.includes('d√©bito') and !p_name.includes('debito') and !p_name.includes('cr√©dito') and !p_name.includes('credito')">
                        <div style="display: flex; justify-content: space-between; font-size: 20px">
                            <span t-esc="payment['name'].substr(0,15)" />
                            <span t-esc="formatCurrency(payment['total'] || 0, false)" />
                        </div>
                    </t>
                </t>

                <!-- Separador punteado -->
                <div style="border-top: 1px dashed black; margin-top: 5px; margin-bottom: 5px;"></div>

                <!-- ========================================== -->
                <!--      DESGLOSE DE IVA (ANTES DEL TOTAL)     -->
                <!-- ========================================== -->
                <t t-if="taxes">
                    <t t-foreach="taxes" t-as="tax" t-key="tax_index">
                        <div style="display: flex; justify-content: space-between; font-size: 18px; color: #444;">
                            <!-- Le puse un color un poco m√°s gris para diferenciar que es desglose -->
                            <span> Impuesto <t t-esc="tax['name']" />:</span>
                            <span t-esc="formatCurrency(tax['tax_amount'], false)" />
                        </div>
                    </t>
                    <!-- Peque√±o espacio antes del total -->
                    <div style="margin-bottom: 5px;"></div>
                </t>
                <!-- ========================================== -->

                <!-- TOTAL GENERAL -->
                <div style="border-top: 3px solid black; margin-top: 2px; padding-top: 5px; display: flex; justify-content: space-between; font-size: 26px; font-weight: 900;">
                    <span>TOTAL VENTA:</span>
                    <span t-esc="formatCurrency(total_products_incl || 0, false)" />
                </div>

                <!-- TOTAL T.P.V. (Solo Tarjetas) -->
                <t t-if="total_tpv and total_tpv > 0">
                    <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; margin-top: 2px;">
                        <span>(Tarjetas):</span>
                        <span t-esc="formatCurrency(total_tpv || 0, false)" />
                    </div>
                </t>
                <br/>

                <!-- 3. DEDUCCIONES -->
                <div style="border-bottom: 2px solid black; margin-bottom: 3px;"></div>
                <div style="font-size: 24px; text-align: center;">DEDUCCIONES</div>
                <div style="border-bottom: 2px solid black; margin-bottom: 5px;"></div>

                <div style="display: flex; justify-content: space-between; font-size: 20px;">
                    <span>DEVOLUCIONES:</span>
                    <span t-esc="formatCurrency(dev_total || 0, false)"/>
                </div>

                <div style="display: flex; justify-content: space-between; font-size: 20px;">
                    <span>DESCUENTOS:</span>
                    <span t-esc="formatCurrency(disc_total || 0, false)"/>
                </div>

                <div style="border-top: 3px solid black; margin-top: 5px; padding-top: 2px; display: flex; justify-content: space-between; font-size: 24px; font-weight: 900;">
                    <span>TOTAL DEDUCCIONES:</span>
                    <span t-esc="formatCurrency(deduction_total || 0, false)"/>
                </div>
                <br/>

                <!-- 4. MOVIMIENTOS CAJA -->
                <div style="border-bottom: 2px solid black; margin-bottom: 3px;"></div>
                <div style="font-size: 24px; text-align: center;">MOVIMIENTOS CAJA</div>
                <div style="border-bottom: 2px solid black; margin-bottom: 5px;"></div>

                <div style="display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; margin-bottom: 5px;">
                    <span>FONDO INICIAL:</span>
                    <span style="font-weight: bold;" t-esc="formatCurrency(opening_cash || 0, false)"/>
                </div>
                <div style="border-bottom: 1px dashed black; margin-bottom: 5px;"></div>

                <div style="font-size: 20px; margin-bottom: 2px;">(+) INGRESOS</div>
                <t t-if="moves_info">
                    <t t-foreach="moves_info" t-as="move" t-key="move_index">
                        <t t-if="move and move['amount'] and move['amount'] &gt; 0">
                            <div style="display: flex; justify-content: space-between; font-size: 20px;">
                                <span style="flex: 1;">
                                    <t t-esc="(move['name'] || 'Movimiento').substr(0,25)"/>
                                </span>
                                <span><t t-esc="formatCurrency(move['amount'], false)"/></span>
                            </div>
                        </t>
                    </t>
                </t>
                <div style="border-top: 1px dashed black; margin-top: 2px;"></div>
                <div style="text-align: right; font-size: 20px; font-weight: bold; margin-bottom: 5px;">
                    Total: <span t-esc="formatCurrency(summary_entradas || 0, false)"/>
                </div>

                <div style="font-size: 20px; margin-bottom: 2px;">(-) RETIROS</div>
                <t t-if="moves_info">
                    <t t-foreach="moves_info" t-as="move" t-key="move_index">
                        <t t-if="move and move['amount'] and move['amount'] &lt; 0">
                            <div style="display: flex; justify-content: space-between; font-size: 20px;">
                                <span style="flex: 1;">
                                    <t t-esc="(move['name'] || 'Retiro').substr(0,25)"/>
                                </span>
                                <span><t t-esc="formatCurrency(move['amount'], false)"/></span>
                            </div>
                        </t>
                    </t>
                </t>
                <div style="border-top: 1px dashed black; margin-top: 2px;"></div>
                <div style="text-align: right; font-size: 20px; font-weight: bold;">
                    Total: <span t-esc="formatCurrency((summary_salidas || 0) * -1, false)"/>
                </div>
                <br/>

                <!-- 5. EFECTIVO DISPONIBLE / ARQUEO -->
                <div style="border-bottom: 2px solid black; margin-bottom: 3px;"></div>

                <div style="font-size: 24px; text-align: center;">
                    <t t-if="is_z_report">ARQUEO EFECTIVO</t>
                    <t t-else=""> BALANCE DE CAJA</t>
                </div>

                <div style="border-bottom: 2px solid black; margin-bottom: 5px;"></div>

                <t t-if="is_z_report">
                    <div style="display: flex; justify-content: space-between; font-size: 20px;">
                        <span>(+) Ventas Efectivo:</span>
                        <span t-esc="formatCurrency(total_cash_sales || 0, false)"/>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 20px;">
                        <span>(+) Entradas Caja:</span>
                        <span t-esc="formatCurrency(summary_entradas || 0, false)"/>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 20px;">
                        <span>(-) Salidas Caja:</span>
                        <span t-esc="formatCurrency((summary_salidas || 0) * -1, false)"/>
                    </div>
                    <div style="border-top: 3px solid black; margin-top: 5px; margin-bottom: 5px;"></div>
                </t>

                <div style="text-align: center; font-size: 20px; font-weight: bold;">
                    <t t-if="is_z_report">EFECTIVO TEORICO:</t>
                    <t t-else="">DISPONIBLE EFECTIVO:</t>
                </div>
                <div style="text-align: center; font-size: 32px; font-weight: 900;">
                    <t t-esc="formatCurrency(theoretical_cash || 0, false)"/>
                </div>

                <div style="text-align: center; font-size: 14px; margin-top: 5px; font-style: italic;">
                    (Dinero f√≠sico en caj√≥n)
                </div>

                <br/><br/>

                <div style="text-align: center; font-size: 18px;">
                    === FIN DEL REPORTE ===
                </div>
            </div>
        </xpath>
    </t>
</templates>