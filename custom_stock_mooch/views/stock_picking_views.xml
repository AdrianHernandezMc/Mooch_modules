<odoo>
    <record id="custom_stock_picking_inherit" model="ir.ui.view">
        <field name="name">custom.stock.picking.inherit</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.view_picking_form"/>
        <field name="arch" type="xml">
            <xpath expr="//page[@name='extra']//group//group[@name='other_infos']" position="after">
                <group string="Envios" name="send_information">
                    <field name="who_transfers" string="Traslada: "/>
                    <field name="who_receive" string="Recibe: "/>
                    <field name="driver" string="Chofer: "/>
                    <field name="plates" string="Placas: "/>
                    <field name="unity" string="Unidad: "/>
                    <field name="box_quantity" string="Cantidad Cajas"/>
                </group>
            </xpath>

            <xpath expr="//field[@name='date_done']" position="after">
                <field name="create_date" string="Creado el" readonly="1"/>
                <field name="date_destination_done"
                       string="Recibido en Destino"
                       readonly="1"
                       modifiers="{
                           'invisible': [
                               ['|',
                                ['picking_type_code', '!=', 'outgoing'],
                                ['date_destination_done', '=', false]
                               ]
                           ]
                       }"/>
            </xpath>
            <xpath expr="//sheet//field[@name='location_dest_id']" position="after">
                <field name="invoice_order_ids"
                    widget="many2many_tags"
                    options="{'no_create': False}"
                    placeholder="Añadir número de factura…"
                    modifiers="{'invisible': [('purchase_id','=',False)]}"/>
            </xpath>

            <!-- Mostrar botón Revertir trasl. solo a Administrador de Inventario -->
            <xpath expr="//button[@data-hotkey='k' and @type='action']" position="attributes">
                <attribute name="groups">stock.group_stock_manager</attribute>
            </xpath>

            <xpath expr="//sheet//field[@name='location_dest_id']" position="after">
                <field name="department" string="Departamento" readonly="1"/>
            </xpath>
        </field>
    </record>

    <!-- ====== Tree de Picking: agregar columna Departamento ====== -->
    <record id="custom_stock_picking_tree_department" model="ir.ui.view">
        <field name="name">stock.picking.tree.department</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.vpicktree"/>
        <field name="priority" eval="17"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="department" string="Departamento"/>
            </xpath>
        </field>
    </record>

    <!-- ====== Search de Picking: campo + agrupar por Departamento ====== -->
    <record id="view_picking_search_inherit_department" model="ir.ui.view">
        <field name="name">stock.picking.search.department</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.view_picking_internal_search"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <field name="department" string="Departamento"/>
                <filter name="group_by_department"
                        string="Agrupar por Departamento"
                        context="{'group_by':'department'}"/>
            </xpath>
        </field>
    </record>

    <!-- ====== Wizard Devolución: forzar visibilidad de 'to_refund' ====== -->
    <record id="view_stock_return_picking_form_force_to_refund" model="ir.ui.view">
        <field name="name">stock.return.picking.form.force.to_refund</field>
        <field name="model">stock.return.picking</field>
        <field name="inherit_id" ref="stock.view_stock_return_picking_form"/>
        <!-- Alta prioridad para ganar a otras vistas que oculten el campo -->
        <field name="priority" eval="999"/>
        <field name="arch" type="xml">
            <!-- Asegurar que la columna 'to_refund' sea visible, editable y sin restricciones -->
            <xpath expr="//field[@name='product_return_moves']/tree/field[@name='to_refund']" position="attributes">
                <attribute name="string">Seleccionar</attribute>
                <attribute name="invisible">0</attribute>
                <attribute name="readonly">0</attribute>
                <attribute name="column_invisible">0</attribute>
                <attribute name="attrs">{}</attribute>
                <attribute name="modifiers">{}</attribute>
                <attribute name="groups"></attribute>
                <attribute name="widget">boolean_toggle</attribute>
            </xpath>
        </field>
    </record>

</odoo>
